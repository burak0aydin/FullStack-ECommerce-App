name: Docker CI/CD

on:
  push:
    branches: [ main, master ]
    paths:
      - 'Back-End/**'
      - 'docker-compose*.yml'
      - 'Dockerfile*'
      - 'Makefile'
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_IMAGE_NAME: smartshop-backend
  DOCKER_REGISTRY: ghcr.io

jobs:
  docker-build-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ—ï¸ Build Backend Docker Image
      run: |
        cd Back-End/SmartShop-Server
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:test .
        docker images
    
    - name: ðŸ§ª Test Docker Container
      run: |
        docker run -d --name test-backend -p 8080:8080 ${{ env.DOCKER_IMAGE_NAME }}:test
        sleep 15
        docker ps
        docker logs test-backend
        
    - name: ðŸ©º Health Check
      run: |
        for i in {1..10}; do
          if curl -f http://localhost:8080/api/products; then
            echo "âœ… Health check passed"
            break
          else
            echo "â³ Waiting for container to be ready... ($i/10)"
            sleep 5
          fi
        done
        
    - name: ðŸ§¹ Cleanup Test Container
      run: |
        docker stop test-backend || true
        docker rm test-backend || true

  docker-compose-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ³ Test Docker Compose Build
      run: |
        docker-compose build
        docker-compose config
    
    - name: ðŸš€ Start Full Stack with Docker Compose
      run: |
        docker-compose up -d
        sleep 30
        docker-compose ps
        
    - name: ðŸ§ª Test Full Stack
      run: |
        # Test database connection
        docker-compose exec -T postgres pg_isready -U postgres
        
        # Test API endpoints
        curl -f http://localhost:8080/api/products || exit 1
        echo "âœ… Full stack test passed"
        
    - name: ðŸ“‹ Show Logs on Failure
      if: failure()
      run: |
        echo "ðŸ” Backend logs:"
        docker-compose logs backend
        echo "ðŸ” Database logs:"
        docker-compose logs postgres
        
    - name: ðŸ§¹ Cleanup
      run: |
        docker-compose down -v

  docker-security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ—ï¸ Build Image for Security Scan
      run: |
        cd Back-End/SmartShop-Server
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:security-scan .
    
    - name: ðŸ”’ Run Trivy Security Scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.DOCKER_IMAGE_NAME }}:security-scan
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: ðŸ“Š Upload Trivy Scan Results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  docker-multi-arch-build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¦ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ³ Set up QEMU
      uses: docker/setup-qemu-action@v3
    
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ—ï¸ Build Multi-Architecture Image
      run: |
        cd Back-End/SmartShop-Server
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --tag ${{ env.DOCKER_IMAGE_NAME }}:multi-arch \
          .
    
    - name: âœ… Multi-Architecture Build Success
      run: echo "ðŸŽ‰ Multi-architecture Docker build completed successfully!"

  deployment-ready:
    needs: [docker-build-test, docker-compose-test, docker-security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸš€ Deployment Ready Notification
      run: |
        echo "ðŸŽ¯ SmartShop Docker Deployment Summary:"
        echo "âœ… Docker Build: Success"
        echo "âœ… Docker Compose: Success"
        echo "âœ… Security Scan: Complete"
        echo "ðŸŒ Ready for production deployment!"
        
    - name: ðŸ“Š Generate Docker Report
      run: |
        echo "# ðŸ³ SmartShop Docker CI/CD Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Build**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Compose**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Scan**: âœ… Complete" >> $GITHUB_STEP_SUMMARY
        echo "- **Multi-Architecture**: âœ… Ready" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "Container images are ready for deployment!" >> $GITHUB_STEP_SUMMARY
